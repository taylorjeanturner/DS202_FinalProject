---
title: "DS202_FinalProject"
author: "Ryan Lode, Taylor Turner, Jonathan Kelly, Molly Carrick, Max Wisnieski"
date: "11/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message= FALSE, include=FALSE}
library(dplyr)
library(lubridate)
library(tidyverse)
library(RColorBrewer)
library(ggrepel)
library(scales)
data <- readr::read_csv('Current_Iowa_Correctional_System_Prison_Population.csv')
```

# Background and Questions Raised #

For our final report, we decided to examine data on the prison population in Iowa. Ongoing problems relating to mass incarceration, law enforcement and judicial bias, as well as recent civil unrest, point to the relevancy of this analysis. Our data was obtained from the Iowa Department of Correction, containing information on prisoner age, sex, Race/Ethnicity, offense type, and other information. In this report, we examined potential patterns among incarcerated persons, seeking answers to following questions:

**Question 1: **Does gender play a role in the type of offense committed?  

**Question 2: **How does the ratio of gender in Iowa prisons compare to the entire state of Iowa's population?

**Question 3: **How is ethnicity represented in Iowa prisons?  

**Question 4: **Is there a relationship between prisoner age and offense type?  

**Question 5: **Does education level impact the probability of being incarcerated for a certain crime?

**Question 6: **How does one's education level and race/ethnicity impact the length of time spent incarcerated?  

**Question 7: **Does race/ethnicity affect the amount of time served for similar crimes?  

**Question 8: **What factors might lead someone to reoffend after being released?  

**Question 9: **How does time served depend on the offense type?  

**Question 10: **How do the ranges of time served for each offense type compare?  

# Obtaining and Cleaning the Dataset #

The dataset was obtained from data.iowa.gov, a website that provides government data for the state of Iowa. Our dataset was pretty clean to begin with so individual members just cleaned the dataset in ways that they deemed fit for their particular exploratory analysis (i.e., renaming columns, selecting necessary columns, filtering data, etc).

# Exploratory Analysis #


## Gender and Offense Type ##

**Question 1: **Does gender play a role in the type of offense committed?

To start off this exploration, I first grouped the data by offense type and sex. I then summarized this data to find the total of types of offenses per gender. I wanted a visualization that would compare the gender balance for each offense type and I decided on a stacked bar chart that does so.
```{r}
offenses <- data%>%
  group_by(`Offense Type`, Sex)%>%
  summarise(Total = n(), .groups = 'drop')
offenses <- offenses %>%
  mutate(Total = ifelse(Sex == "Male",Total,-1*Total))
breaks_values <- pretty(offenses$Total)
ggplot(data = offenses, aes(x=reorder(`Offense Type`, Total), y = Total, fill=Sex))+
  geom_bar(stat = "identity", width = 0.75)+
  coord_flip()+
  scale_y_continuous(breaks = breaks_values, labels = abs(breaks_values))+ 
  scale_fill_brewer(palette = "Set1")+
  geom_hline(yintercept = 0)+
  ggtitle("How Gender Affects Offense Type")+
  xlab("Offense")
```

**Analysis: **We can see that each offense type is overwhelmingly male dominated. There's not a single offense type that is even made up of even a quarter women. So, men are more likely to commit any of the offenses. Due to this staggering imbalance of gender, I decided to further this investigation and see how the ratio of gender in Iowa prisons compares to the entire state of Iowa. This brings us to question 2.

**Question 2: **How does the ratio of gender in Iowa prisons compare to the entire state of Iowa's population?

For this questions I found an outside data source that contained the amount of men and the amount of women in the entire state of Iowa. This dataset is from the US Census Bureau. To clean this dataset, I selected only the columns that contained men and women. I then had to use pivot longer in order to make the dataset look like our original prison dataset. I then took both datasets and found the percentage of men and the percentage of women in comparison to their respective population. Finally, I used a bar chart to show each gender and used text labels to show the percentage on the plot.
```{r}
genderInIA <- readr::read_csv('IowaData.csv', col_types = cols())
genderInIA <- genderInIA%>%
  rename(Male = S0101_C03_001E, Female = S0101_C05_001E)%>%
  select(Male, Female)
keep = c(FALSE, TRUE)
genderInIA <- genderInIA[keep,]
genderInIA$Male <- as.numeric(genderInIA$Male)
genderInIA$Female <- as.numeric(genderInIA$Female)

genderInIA <- genderInIA %>%
  pivot_longer(cols = c(Male, Female), names_to = "Sex", values_to = "total")%>%
  mutate(Percent = label_percent()(total/sum(total)))
  
genderInPrison <- data%>%group_by(Sex)%>%
  summarise(Total=n(), .groups = 'drop')%>%
  mutate(Percent = label_percent()(Total/sum(Total)))

ggplot(genderInIA, aes(x=Sex, y=total, fill=Sex))+
  geom_bar(stat='identity', width = .5)+ 
  scale_fill_brewer(palette = "Set1")+
  ggtitle("Male to Female Ratio for Iowa")+
  geom_text(aes(label=Percent), vjust=0)

ggplot(genderInPrison, aes(x=Sex, y=Total, fill=Sex))+
  geom_bar(stat='identity', width = .5)+ 
  scale_fill_brewer(palette = "Set1")+
  ggtitle("Male to Female Ratio for Iowa Correctional System Prison Population")+
  geom_text(aes(label=Percent), vjust=0)
```

**Analysis: **These plots show that Iowa's total population is made up of 50.38% women and 49.62% men, while Iowa's prison population is made up of only 7% women and 93% men. Thus, we can see that men are severely overrepresented in Iowa prisons while women are underrepresented in Iowa prisons in comparison to Iowa's total population.

## Education level and crime subtype ##

**Question 5: **Does a person's education level impact the probability of being incarcerated for a certain crime?  

In this analysis, I wanted to understand if a person is more likely to commit a certain crime, given a level of education. Therefore, I reasoned that a stacked bar chart, where the width of the bars represents the proportion of a particular offense being committed. Morever, if I could break the prison population into educational groups before plotting, I could generate something close to a mosaic plot.To answer this, the following steps were undertaken to clean/process the data:  

*Step 1: Reading in data and initial processing*  

A new dataframe, prisonData was generated by reading in the prison population data. Then, the education levels were reordered from lower education to higher education. Some values in the education category column were completely blank, so they were filled with NA values. Those NA values were used to filter out the unknown education rows into a new data frame prisonData2.


```{r, warning=FALSE}
prisonData <- read.csv('./Current_Iowa_Correctional_System_Prison_Population.csv')
prisonData$Education.Category <- factor(prisonData$Education.Category , levels = c('No HS Diploma','HS Diploma or Equivelent','Post-Secondary'))
prisonData$Education.Category[prisonData$Education.Category == ""] <-NA
prisonData2 <- prisonData %>%
filter(!is.na(Education.Category))
```

*Step 2: Reassigning small offense subtype categories*   
One of the difficulties faced in this analysis was the very small offense subtype categories. For example, the 'Stolen Property' subtype was a single datapoint. For better visualization, this was moved to theft category. A similar decision was made for the animals, prostituion/pimping, alcohol, and other small categories. There were a few other reassignments, that were done by methodically examining the data. For example, datapoints where the description was 'Burglary 1st degree' were not originally grouped into the burglary category. Additionally, attempted burgulary was moved to the burglary category since the criminal intent was the same.
```{r}

prisonData2$Offense.Subtype <- as.factor(prisonData2$Offense.Subtype)

prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Stolen Property'] <- 'Theft'
#1 datapoint, similar type of crime
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Animals'] <- 'Other Violent'
#1 data point, Crime: Animal Torture was judged to belong in Other Violent due to heinousness of crime
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Prostitution/Pimping'] <- 'Sex' 
#4 data points in this category, sex crime related
prisonData2$Offense.Subtype[prisonData2$Offense.Description == 'BURGLARY 1ST DEGREE'] <- 'Burglary' 
#For analysis, this is more meaningful in the burglary category
prisonData2$Offense.Subtype[prisonData2$Offense.Description == 'ATTEMPT BURGLARY 1ST DEGREE'] <- 'Burglary'
#Grouped with burglarly since the criminal intent was the same 
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Alcohol']<- 'Other Criminal' 
#1 data point, Other criminal seemed best categorical fit
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Flight/Escape']<- 'Other Criminal' 
#Only 16 data points, Other criminal seemed best categorical fit
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Other Drug']<- 'Other Criminal' 
#Only 24 datapoints, Offense description included descriptions such as 'failure to affix Tax Stamp'
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Vandalism']<- 'Other Criminal' 
#Only 52 datapoints, 
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Arson']<- 'Other Violent' 
#Only 57 datapoints, barely visible in original plot, moved to Other Violent due to heinousness of crime
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'OWI']<- 'Other Public Order'
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Traffic']<- 'Other Public Order' 
#Only 60 data points, general offense type already classified as Public Order 
prisonData2$Offense.Subtype[prisonData2$Offense.Subtype == 'Weapons']<- 'Other Public Order' 
#Offense type already classified as public Order and most serious was aggravated misdemeanor 
```

*Step 3: Preparation for Plotting*  

A newdataframe, prisonData3 was generated by filtering out offense subtype categories that are no longer used. The vector plotColors was made by combining a single color from the "Dark2" palette to the "Paired" color palette. This was done because the number of colors in the "Paired" color palette was just insufficient to match the number of offense subtype categories. This was used to generate a stacked bar chart, faceted by education category. 

```{r, warning= FALSE}

prisonData3 <- prisonData2 %>%
  filter(!Offense.Subtype %in% c('Arson','Alcohol', 'Animals','Flight/Escape', 'None', 'Other Drug','OWI','Prostitution/Pimping','Stolen Property','Traffic', 'Vandalism','Weapons'))

plotColors = c((brewer.pal(name="Dark2", n = 1)), brewer.pal(name="Paired", n = 12))

ggplot(data = prisonData3, aes(x = Education.Category, fill = Offense.Subtype)) + geom_bar(position = 'fill') + scale_fill_manual(values = plotColors, name = 'Offense Type') + ggtitle('Proportional Breakdown of Offense Type by Education Level') + xlab('Education Level') + ylab('Relative Frequency')

```

**Analysis: **There are several categories that proportionally, don't seem to change by education level. This is not the case for all categories, however, as the probability of a person being incarcerated due to assault or burglary does seem to decline with increasing education level. Additionally, the probability of being incarcerated for a sex crime seems to increase with higher levels of education.

## Education level, Race/Ethnicity impact on length of incarceration ##

**Question 6: **How does one's education level and race/ethnicity impact the length of time spent incarcerated?

Racial bias in law enforcement and in the judiciary has been the subject of intense scrutiny in the media of late. Therefore, I thought it would be useful to examine a potential source of bias in Iowa's prisons. The data set used in this analysis contained a column that indicated the amount of time a  prisoner has spent incarcerated to date. This value could be used as a proxy for incarceration length. In other words, I could examine if people with different racial//ethnic backgrounds are serving more or less time, even if they have the same educational level. 

*Cleaning, Processing, and then Plotting:*

A new dataframe, prisonData5, was created from the prisonData2 dataframe. Because the number of Hispanic, American Indian or Alaska Native, and Asian or Pacific Islanders was very small, this made meaningful visualization difficult. To adjust for this, those groups were all reassigned to the Race/Ethnicity category 'His/AP/Ind'. In doing this, we are aware of the pitfalls of grouping people from such diverse racial/ethnic groups together, and this analysis does not imply that those groups are at all the same.This was *only* done for clean visualization purposes. In this analysis, that category should simply be viewed as 'Not Black or White' at a high level. Once this was done, a plot could then be created. The distribution of the length of time served was generated by plotting the Months.served column on the x-axis with geom_histogram. This plot was then faceted by race/ethnicity and education level. 

```{r, message= FALSE}
prisonData5 <-prisonData2

prisonData5$Race...Ethnicity[prisonData5$Race...Ethnicity == 'Hispanic'] <-'His/AP/Ind' 
prisonData5$Race...Ethnicity[prisonData5$Race...Ethnicity == 'American Indian or Alaska Native'] <-'His/AP/Ind' 
prisonData5$Race...Ethnicity[prisonData5$Race...Ethnicity == 'Asian or Pacific Islander'] <-'His/AP/Ind'

prisonData5a <- prisonData5
prisonData5$Race...Ethnicity <- as.factor(prisonData5$Race...Ethnicity)


ggplot(data = prisonData5, aes(x = Months.Served, fill = Race...Ethnicity)) + geom_histogram(position = 'stack') + facet_wrap(Race...Ethnicity~Education.Category, scales = 'free') + ggtitle('Distribution of Time Served by Education Level-Faceted by Race/Ethnicity') + xlab('Months Served') + ylab('Count')

```

**Analysis: **Each distribution in this plot is unimodal, and right-skewed, with the vast majority of incarcerated people having served under a 100 months. However, there were several individual histograms with a very small maximum y value, in the post-secondary education plots. At a cursory glance, race/ethnicity and education don't appear to have much of an impact on the length of time incarcerated. However, summary statistics generated later (not shown), indicated that white prisoners appeared to have a slightly lower median incarceration time across all educational levels, except those in the His/AP/Ind category with Post-Secondary Educations. 

**Question 7: **Does race/ethnicity affect the amount of time served for similar crimes?  

As previously stated, racial bias is a huge problem in the United States judicial system. Because of this I wanted to know if the Iowa judicial system was guilty of it too. For this I looked at the time the prisoner served, the race/ethnicity of the prisoner, and the federal classification of the crime they committed. Additionally, I only wanted to look at first time offenders because multiple offenses could result in a longer sentence.

*Cleaning and Plotting*

The data set we used was already very clean, so there wasn't a whole lot of cleaning that needed to be done. The first step I did was filter out all of the data points that had a return admission type, so only first time offenders remained. Next, I removed some of the crime classifications due to them only having data for one or two races. This was done because no clear conclusion would be able to be made without looking at all races. For plotting I loaded race/ethnicity on the x-axis, and time served on the y-axis. I then used geom_boxplot to visualize the data, and used facet_wrap by offense classification to group the plots by similar crimes. Finally I used free_y to allow each plot to have a different y-axis because different crimes will have different typical sentences.

```{r}
# Loading and Cleaning

df <- read.csv('Current_Iowa_Correctional_System_Prison_Population.csv')

df <- df %>%
  filter(Prison.Admission.Type == "New Admit New Sentence" & Offense.Classification != "None" & Offense.Classification != "Felony - Mandatory Minimum" & Offense.Classification != "Simple Misdemeanor" & Offense.Classification != "Serious Misdemeanor" & Offense.Classification != "Other Felony")

# Plotting

ggplot(df, aes(x = Race...Ethnicity, y = Months.Served)) +
  geom_boxplot() + facet_wrap(~Offense.Classification, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1)) +
  labs(x = "Ethnicity", y = "Months Served", title = "Months Served for Ethnicities Grouped by Offense Classification")
```

**Analysis: **Looking at the box plots we can see that the average time served is very similar across every race for the respective crimes. While there are outliers in the plots, every race has at least one or two large outliers. Thus, I feel the plot is enough to conclude that race/ethnicity has little to no affect on the sentence length for similar crimes in the state of Iowa.

**Question 8: **What factors might lead someone to reoffend after being released? 

For this question I want to know what might affect the likelyhood of someone reoffending. The areas I looked into were race/ethnicity, age, and education of the prisoners. I also made sure to filter out the data for first time offenders. Additionally, I wanted to know what type of crimes people typically commit when the reoffend, and who is the most likely to reoffend in Iowa.

*Cleaning and Plotting*

As stated previously, the data set we used was already very clean, so the cleaning process was fairly simple. First I filtered the data on only include those who were returning to prison. Next, the education column had some empty spaces, so I filled those in with NA. Then for the plotting I made a lot of plots for this section. First I made bar charts to look at the distribution of reoffenders for different races and education levels. Next I made a histogram to look at the distribution of their ages. Thirdly, I created another bar chart to look at the frequency of different crimes commited by the reoffender. Finally, I created a stacked bar chart of the crimes committed by race to see what each typically does to reoffend.

```{r}
# Loading and Cleaning

df <- read.csv('Current_Iowa_Correctional_System_Prison_Population.csv')

df <- df %>%
  filter(Prison.Admission.Type != "New Admit New Sentence" & Prison.Admission.Type != "Other")
df$Education.Category <- replace(df$Education.Category, df$Education.Category == "", NA) 

# Plotting

ggplot(df, aes(x = Age)) +
  geom_histogram() +
  labs(x = "Age", y = "Count", title = "Age Distribution of Reoffenders")

ggplot(df, aes(x = Race...Ethnicity)) +
  geom_bar() +
  labs(x = "Race/Ethnicity", y = "Count", title = "Total Reoffenders by Race/Ethnicity") +
  theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1))

ggplot(df, aes(x = Education.Category)) +
  geom_bar() +
  labs(x = "Education Category", y = "Count", title = "Total Reoffenders by Education Category")

ggplot(df, aes(x = Offense.Type)) +
  geom_bar() +
  labs(x = "Offense Type", y = "Count", title = "Total Reoffenders by Offense Type")

ggplot(df, aes(x = Offense.Subtype)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(x = "Offense Subtype", y = "Count", title = "Total Reoffenders by Offense Subtype")

ra <- df %>%
  group_by(interaction(Race...Ethnicity, Offense.Type, sep = " . ")) %>%
  summarize(n = n()) %>%
  rename(total = "n") %>%
  separate('interaction(Race...Ethnicity, Offense.Type, sep = " . ")', into = c("Race...Ethnicity", "Offense_Type"), sep = " . ")

ggplot(ra, aes(x = Race...Ethnicity, y = total, fill = Offense_Type)) +
  geom_bar(position="stack", stat="identity") +
  labs(x = "Race/Ethnicity", y = "Count", title = "Offense Type Totals by Race/Ethnicity") +
  theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1))
```

**Analysis: **Looking at the first two plots it is clear the the most common reoffenders are white people with a high school diploma or equivalent. This is not surprising due to the demographics of Iowa being predominantly white. Next, for the age histogram the shape is almost exactly the same as the ages for all offenders. The only difference is a slightly smaller range, so the oldest offenders are the least likely to reoffend. For the offenses, the three most common types are drug, property, and violent crimes, in that order. Finally, looking at the crimes by race we can see that white people are most likely to reoffend with a drug or property crime, while black people are most likely to have a property or violent crime. Overall, the most common reoffender is a white person with drug charges.

# Conclusion #

**We have found that: **

  * There are more men compared to women in Iowa prisons and compared to Iowaâ€™s total population, men are overrepresented
  * Education level does appear to impact the probability of being incarcerated for a certain crime
  * White people have been incarcerated for a slightly lower median length across most education levels
  * Asian men are underrepresented in Iowa prisons.  In all other racial categories, men are overrepresented.  Females are underrepresented in all categories, besides American Indian.
  * The age of a prisoner is not a good predictor of the crime committed.
  * Race appears to have little to no effect on the amount of time served for similar crimes
  * The most common reoffender is a white person for drug charges
  * The biggest difference in the amount of time served is in the classification of offense received

# Contributions of Work #

**Ryan: **For this project, I examined the impact education level had on the probability of being incarcerated for a certain crime. Additionally, I examined how race/ethnicity, along with education, impacted the distribution of time incarcerated in months (questions 5, 6). Finally, I also wrote up the background and questions raised section of the final work, while also presenting my findings to the class. 

**Taylor: **I found and suggested the data set that we used for the project. I created our team's proposal. I explored if gender played a role in type of offense. I also found another data set to help further my investigation into the distribution of gender in prisons and if either gender was overrepresented in prison. For our presentation I wrote and presented the background of our dataset as well as my own findings.

**Molly: **

**Max: **First I looked into race/ethnicity to see how it might affect the length of time someone might be sentenced to for a similar federal crime classification. Next, I looked into factors the might lead somebody to reoffend after they have been released from prison. Additionally I looked into what crimes most people commit to be sent back to prison. I then presented all of my findings to the group.

**Jonathan: **

